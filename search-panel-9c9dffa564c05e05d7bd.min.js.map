{"version":3,"sources":["webpack:///webpack/bootstrap 9c9dffa564c05e05d7bd","webpack:///./src/chunks/search-panel.js"],"names":[],"mappings":";QAAA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;;QAEA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;;;QAGA;QACA;;QAEA;QACA;;QAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA,KAAK;QACL;QACA;;QAEA;QACA;QACA;QACA,2BAA2B,0BAA0B,EAAE;QACvD,iCAAiC,eAAe;QAChD;QACA;QACA;;QAEA;QACA,sDAAsD,+DAA+D;;QAErH;QACA;;QAEA;QACA;;;;;;;;AC7DA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA,iCAAiC,eAAe;AAChD;AACA;AACA;AACA;AACA;AACA,0CAA0C,eAAe;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCAAoC,eAAe;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,sCAAsC,iBAAiB;AACvD;AACA;;AAEA,aAAa,QAAQ;AACrB;;AAEA,aAAa,OAAO;AACpB;;AAEA,iCAAiC,gBAAgB;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,gCAAgC,iBAAiB;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,+BAA+B,iBAAiB;AAChD;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,eAAe,OAAO;AACtB,gBAAgB,cAAc;AAC9B,gBAAgB,OAAO;AACvB,gBAAgB,OAAO;AACvB,gBAAgB,cAAc;AAC9B,gBAAgB,OAAO;AACvB,gBAAgB,cAAc;AAC9B,gBAAgB,OAAO;AACvB,gBAAgB,OAAO;AACvB;;AAEA;AACA,YAAY;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,cAAc,aAAa;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,8DAA8D,qBAAqB,EAAE;AACrF;AACA,UAAU;AACV;AACA,mCAAmC,UAAU,gBAAgB,eAAe;AAC5E,aAAa,gBAAgB;AAC7B,gBAAgB,mBAAmB,SAAS,kBAAkB;AAC9D;AACA;AACA;AACA,iBAAiB,gBAAgB,IAAI,kBAAkB;AACvD;AACA,+DAA+D,eAAe;AAC9E;AACA;AACA,UAAU,gBAAgB,kEAAkE;AAC5F;AACA,MAAM,uDAAuD,kBAAkB;AAC/E;AACA;AACA,iGAAiG;AACjG;AACA,UAAU,gBAAgB,kBAAkB;AAC5C;AACA;AACA,mBAAmB,gBAAgB;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,eAAe;AAC5B;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,YAAY,0BAA0B;AACtC;;AAEA;;AAEA;AACA,YAAY;AACZ;AACA;;AAEA;AACA,YAAY;AACZ;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA,aAAa,QAAQ;AACrB;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,QAAQ;AACrB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,SAAS;AACzC;AACA;AACA;AACA;AACA,eAAe,yBAAyB;AACxC;AACA;AACA;AACA,4CAA4C,OAAO;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,mBAAmB,iBAAiB;AACpC;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,wBAAwB,eAAe;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,cAAc;AAC3B;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,WAAW;AACxB;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,WAAW;AACxB;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,cAAc,qCAAqC;AACnD,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCAAoC,sBAAsB,sBAAsB;AAChF;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,aAAa,MAAM;AACnB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,cAAc,WAAW;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL;AACA;AACA;;AAEA;AACA,CAAC","file":"search-panel-9c9dffa564c05e05d7bd.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 16);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 9c9dffa564c05e05d7bd","// @ts-check\n\n$(document).ready(function () {\n  /// Start...\n\n  const isDev = window.location.host.startsWith('localhost');\n\n  /** Generate a list of random (*) products. Only for dev mode. */\n  const __genertateDemoProducts = true;\n\n  const maxDisplayingProducts = 3;\n\n  // Required node:\n  const searchPanel = /** @type {HTMLDivElement} */ (document.getElementById('search-panel'));\n  if (!searchPanel) {\n    console.error('[search-panel:init] No search panel node found');\n    debugger;\n    return;\n  }\n  const searchPanelContainer = /** @type {HTMLDivElement} */ (\n    searchPanel.querySelector('.container')\n  );\n  if (!searchPanelContainer) {\n    console.error('[search-panel:init] No search panel container found');\n    debugger;\n    return;\n  }\n  const itemsContainer = /** @type {HTMLDivElement} */ (\n    searchPanel.querySelector('.results-panel-items')\n  );\n  if (!itemsContainer) {\n    console.error('[search-panel:init] No search panel items container found');\n    debugger;\n    return;\n  }\n\n  // Other optional nodes...\n  const resultsCountNode = /** @type {HTMLElement|null} */ (\n    searchPanel.querySelector('#results-count')\n  );\n\n  /** @type {boolean} */\n  let isVisible = searchPanel.classList.contains('visible');\n\n  /** @type {string} */\n  let searchValue = '';\n\n  const triggerForm = /** @type {HTMLFormElement} */ (\n    document.getElementById('search-panel-trigger')\n  );\n  if (!triggerForm) {\n    console.warn('[search-panel:init] No search panel trigger form found');\n    debugger;\n    return;\n  }\n\n  const panelInput = /** @type {HTMLInputElement} */ (\n    searchPanel.querySelector('#search-panel-input')\n  );\n  if (!panelInput) {\n    console.warn('[search-panel:init] No search panel input field found');\n    debugger;\n    return;\n  }\n\n  const bodyInput = /** @type {HTMLInputElement} */ (triggerForm.querySelector('input[name=\"q\"]'));\n  if (!panelInput) {\n    console.warn('[search-panel:init] No body form input field found');\n    debugger;\n    return;\n  }\n\n  /// Render products...\n\n  /**\n   * @typedef {Object} ProductsItem\n   * @property {string|number} id - Product id or art.no\n   * @property {string} value - Product title\n   * @property {string} text - Product short name (whatever it is)\n   * @property {number|string} price - Price, eg '1 300' (space delimited)\n   * @property {string} [units] - Currency, optional, default is \"р.\" (Russian rubles)\n   * @property {number|string} [oldPrice] - Old price, the same as `price`, optional\n   * @property {string} url - Url in the catalogue\n   * @property {string} imgUrl - Image url\n   */\n\n  /** Sample product item data\n   * @type {ProductsItem}\n   */\n  const sampleProduct = {\n    id: 70063,\n    value:\n      '70063 Акан Краска водорастворимая Western Approaches Blue окраска надводных бортов кораблей ВМФ Англии с 1941 года',\n    text: '70063',\n    price: '1 200',\n    oldPrice: '1 650',\n    url: '/goods/klei/akan/123/110/38247.html',\n    imgUrl: '/assets/example/product.png', // '/file/i/207/207/769436ae/bdb355b865c7d64c38322a06dd7221d6.jpg',\n  };\n\n  /** @param {ProductsItem} item */\n  function renderProductItem(item) {\n    const {\n      id, // Product id or art.no\n      value: title, // Product title\n      // text, // Product short name (whatever it is)\n      price, // Price, eg '1 300' (space delimited)\n      units = 'р.', // Currency, optional, default is \"р.\" (Russian rubles)\n      oldPrice, // Old price, the same as `price`, optional\n      url, // Url in the catalogue\n      imgUrl, // Image url\n    } = item;\n    const className = ['prod-item', !!oldPrice && 'has_old_price'].filter(Boolean).join(' ');\n    const oldPriceContent = oldPrice\n      ? `<span class=\"prod-item__price_old_price old_price\">${escapeHtml(oldPrice)}${escapeHtml(\n          units,\n        )}</span>`\n      : '';\n    const content = `<div class=\"${className}\" id=\"product-${escapeHtml(id)}\">\n  <a href=\"${escapeHtml(url)}\" class=\"img-holder\">\n    <img src=\"${escapeHtml(imgUrl)}\" alt=\"${escapeHtml(title)}\" />\n  </a>\n  <div class=\"prod-item__right\">\n    <div class=\"prod-item__name\">\n      <a href=\"${escapeHtml(url)}\">${escapeHtml(title)}</a>\n    </div>\n    <div class=\"d-flex txt_14px align-items-center\">Артикул: ${escapeHtml(id)}</div>\n    <div class=\"prod-item__price_and_buttons\">\n      <p class=\"prod-item__price\">\n        ${oldPriceContent} <span class=\"prod-item__price_value\" data-thousand-separate=\"\">${escapeHtml(\n      price,\n    )}</span><span class=\"prod-item__price_units txt_14px\">${escapeHtml(units)}</span>\n      </p>\n      <div class=\"prod-item_buttons\">\n        <button data-remote=\"/add/ok\" class=\"prod-item__btn_cart btn red\" data-buy=\"\" data-id=\"${escapeHtml(\n          id,\n        )}\" data-price=\"${escapeHtml(price)}\" title=\"Добавить в корзину\">\n          <i class=\"icon icon_cart text-white txt_12px mr-2\"></i> в корзину\n        </button>\n        <a href=\"${escapeHtml(url)}\" class=\"prod-item__btn_go btn gray\" title=\"Перейти к продукту\">\n          <span>🡢</span>\n        </a>\n      </div>\n    </div>\n  </div>\n</div>`;\n    return content;\n  }\n\n  /** Renders first `maxDisplayingProducts` items of retrieved products.\n   * @param {ProductsItem[]} items\n   */\n  function renderProducts(items) {\n    const content = items.slice(0, maxDisplayingProducts).map(renderProductItem).join('\\n');\n    // NOTE: All the substituted values are escaped\n    itemsContainer.innerHTML = content;\n  }\n\n  /// Server request...\n\n  /** AbortController instance\n   * @type {AbortController|undefined} */\n  let requestController = undefined;\n\n  const apiPathPrefix = !isDev ? '/search/suggestion/?q=' : '/assets/suggestion.json?q=';\n\n  /** Queued request timer handler\n   * @type {ReturnType<typeof setTimeout>|undefined}\n   */\n  let queueTimerHandler = undefined;\n\n  /** Delay to invoke the server request\n   * @type {number}\n   */\n  const acceptChangesDelay = 1000;\n\n  let dataHasBeenLoaded = false;\n\n  let loadingCounter = 0;\n  let waitingCounter = 0;\n\n  /** Set loading panel status\n   * @param {boolean} value\n   */\n  function setLoading(value) {\n    loadingCounter += value ? 1 : -1;\n    searchPanel.classList.toggle('loading', loadingCounter > 0);\n  }\n\n  /** Set waiting panel status\n   * @param {boolean} value\n   */\n  function setWaiting(value) {\n    waitingCounter += value ? 1 : -1;\n    searchPanel.classList.toggle('waiting', waitingCounter > 0);\n  }\n\n  function requestServerData() {\n    // Prepare data...\n    const value = searchValue;\n    const encodedValue = encodeURIComponent(searchValue);\n    // Clear timer\n    clearQueueTimer();\n    // Check active request\n    if (requestController) {\n      // Cancel previously created request, if it's exists\n      requestController.abort();\n    }\n    requestController = new AbortController();\n    const signal = requestController.signal;\n    // Prepare request...\n    const url = apiPathPrefix + encodedValue;\n    // Send and process the request...\n    setLoading(true);\n    const promise = fetch(url, { signal })\n      .then(async (res) => {\n        if (isDev) {\n          await new Promise((resolve) => setTimeout(resolve, 1000));\n        }\n        const { ok, status, statusText } = res;\n        const body = await res.text();\n        if (!ok) {\n          const reason = [status, statusText].filter(Boolean).join(', ');\n          const errMsg = `Request failed (${reason})`;\n          console.error('[search-panel:requestServerData]', errMsg, {\n            status,\n            statusText,\n            body,\n            res,\n            url,\n          });\n          throw new Error(errMsg);\n        }\n        /** @type {object|undefined} */\n        let data = undefined;\n        try {\n          data = JSON.parse(body);\n        } catch (error) {\n          const errMsg = 'Cannot parse response';\n          console.error('[search-panel:requestServerData]', errMsg, {\n            error,\n            body,\n            res,\n            url,\n          });\n          throw new Error(errMsg);\n        }\n        if (!data) {\n          throw new Error('Empty data returned');\n        }\n        if (!Array.isArray(data)) {\n          throw new Error('Expected array data');\n        }\n        return data;\n      })\n      .then((/** @type {ProductsItem[]} */ items) => {\n        // DEMO: Create random data...\n        if (isDev && __genertateDemoProducts) {\n          const count = Math.floor(Math.random() * 6);\n          items = Array.from(Array(count)).map((_none, no) => {\n            // return sampleProduct;\n            const id = 1000 + Math.round(Math.random() * 9000);\n            const price = 50 + Math.round(Math.random() * 600);\n            return Object.assign({}, sampleProduct, {\n              id,\n              value: sampleProduct.value.replace(/^\\d+/, String(id)),\n              price,\n              oldPrice: Math.round(Math.random()) ? price + Math.round(Math.random() * 300) : '',\n            });\n          });\n        }\n        // Render received data\n        renderProducts(items);\n        // Update the state\n        const itemsCount = items.length;\n        resultsCountNode && (resultsCountNode.innerText = String(itemsCount));\n        searchPanel.classList.toggle('has_results', !!itemsCount);\n        dataHasBeenLoaded = true;\n      })\n      .catch((error) => {\n        if (error.name !== 'AbortError') {\n          console.error('[search-panel:requestServerData]', {\n            error,\n            url,\n          });\n          debugger;\n        }\n      })\n      .finally(() => {\n        setLoading(false);\n        requestController = undefined;\n      });\n    return promise;\n  }\n\n  function clearQueueTimer() {\n    if (queueTimerHandler) {\n      clearTimeout(queueTimerHandler);\n      queueTimerHandler = undefined;\n      setWaiting(false);\n    }\n  }\n\n  function setQueueTimer() {\n    clearQueueTimer();\n    queueTimerHandler = setTimeout(requestServerData, acceptChangesDelay);\n    setWaiting(true);\n  }\n\n  /// Routines...\n\n  function closePanel() {\n    if (isVisible) {\n      isVisible = false;\n      updatePanelStatus();\n    }\n  }\n\n  /** Close the panel if the Escape key clicked\n   * @param {KeyboardEvent} ev\n   */\n  function detectEsc(ev) {\n    if (ev.key === 'Escape') {\n      closePanel();\n    }\n  }\n\n  /** Prevent close the panel if it's been clicked inside\n   * @param {MouseEvent} ev\n   */\n  function preventClose(ev) {\n    ev.preventDefault();\n    ev.stopPropagation();\n  }\n\n  /** Close the panel by click outside the panel (see `preventClose` method above)\n   * @param {MouseEvent} _ev\n   */\n  function closeByClick(_ev) {\n    closePanel();\n  }\n\n  function goToResults() {\n    triggerForm.submit();\n  }\n\n  /** @param {string|number|boolean|undefined|null} str\n   * @return {string}\n   */\n  function escapeHtml(str) {\n    if (str == undefined) {\n      return '';\n    }\n    if (typeof str !== 'string') {\n      str = String(str);\n    }\n    str = str.trim();\n    return str.replace(/\"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n  }\n\n  /** Sync search text in document with current value */\n  function updateSearchValueInDocument() {\n    const escapedValue = escapeHtml(searchValue);\n    bodyInput.value = escapedValue;\n    panelInput.value = escapedValue;\n  }\n\n  /** Search text has been changed\n   * @param {Event} _ev\n   */\n  function panelInputChanged(_ev) {\n    searchValue = panelInput.value;\n    bodyInput.value = searchValue;\n    setQueueTimer();\n  }\n\n  function updatePanelStatus() {\n    updateSearchValueInDocument();\n    searchPanel.classList.toggle('visible', !!isVisible);\n    // Set/reset event handlers\n    if (isVisible) {\n      panelInput.addEventListener('input', panelInputChanged);\n      searchPanelContainer.addEventListener('mouseup', preventClose, true);\n      document.addEventListener('mouseup', closeByClick);\n      document.addEventListener('keydown', detectEsc);\n    } else {\n      panelInput.removeEventListener('input', panelInputChanged);\n      searchPanelContainer.addEventListener('mouseup', preventClose);\n      document.removeEventListener('mouseup', closeByClick);\n      document.removeEventListener('keydown', detectEsc);\n    }\n    // Focus in the input field\n    if (isVisible) {\n      setTimeout(() => panelInput.focus(), 100);\n    }\n  }\n\n  /** @param {MouseEvent} ev */\n  function onTriggerClick(ev) {\n    ev.preventDefault();\n    ev.stopPropagation();\n    isVisible = !isVisible;\n    if (!dataHasBeenLoaded && isVisible && searchValue) {\n      requestServerData();\n    }\n    updatePanelStatus();\n  }\n\n  function init() {\n    const closeButton = searchPanel.querySelector('#close-button');\n    const goToResultsButton = searchPanel.querySelector('#go-to-results');\n    const searchPanelButtonButton = searchPanel.querySelector('#search-panel-button');\n\n    const urlParams = new URLSearchParams(window.location.search);\n    searchValue = urlParams.get('q') || '';\n\n    triggerForm.addEventListener('click', onTriggerClick);\n    closeButton && closeButton.addEventListener('click', closePanel);\n    goToResultsButton && goToResultsButton.addEventListener('click', goToResults);\n    searchPanelButtonButton && searchPanelButtonButton.addEventListener('click', goToResults);\n\n    if (isVisible) {\n      updatePanelStatus();\n    } else {\n      updateSearchValueInDocument();\n    }\n  }\n\n  init();\n});\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/chunks/search-panel.js\n// module id = 16\n// module chunks = 3"],"sourceRoot":""}